name: Build & Publish

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      engine_version:
        description: 'chitin-engine release tag (e.g. v0.1.0). Defaults to latest.'
        required: false
        default: 'latest'

jobs:
  # Build a pure Python wheel (no bundled .so â€” user provides library)
  pure-wheel:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build sdist and pure wheel
        run: |
          pip install build
          python -m build

      - uses: actions/upload-artifact@v4
        with:
          name: dist-pure
          path: dist/

  # Build platform wheels with the shared library bundled
  platform-wheels:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: manylinux_2_17_x86_64
            artifact: libchitin-x86_64-linux.so
            lib_name: libchitin.so
          - platform: manylinux_2_17_aarch64
            artifact: libchitin-aarch64-linux.so
            lib_name: libchitin.so
          - platform: macosx_13_0_x86_64
            artifact: libchitin-x86_64-macos.dylib
            lib_name: libchitin.dylib
          - platform: macosx_14_0_arm64
            artifact: libchitin-aarch64-macos.dylib
            lib_name: libchitin.dylib
          - platform: win_amd64
            artifact: chitin-x86_64-windows.dll
            lib_name: chitin.dll

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Resolve engine version
        id: version
        run: |
          if [ "${{ github.event.inputs.engine_version }}" = "latest" ] || [ -z "${{ github.event.inputs.engine_version }}" ]; then
            TAG=$(gh release view --repo datagoboom/chitin-engine --json tagName -q .tagName)
          else
            TAG="${{ github.event.inputs.engine_version }}"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download shared library from chitin-engine release
        run: |
          mkdir -p chitin/_lib
          gh release download "${{ steps.version.outputs.tag }}" \
            --repo datagoboom/chitin-engine \
            --pattern "${{ matrix.artifact }}" \
            --dir chitin/_lib
          mv "chitin/_lib/${{ matrix.artifact }}" "chitin/_lib/${{ matrix.lib_name }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build platform wheel
        run: |
          pip install build wheel setuptools
          python setup_platform.py bdist_wheel --plat-name ${{ matrix.platform }}

      - uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.platform }}
          path: dist/*.whl

  release:
    needs: [pure-wheel, platform-wheels]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Collect all wheels
        run: |
          mkdir -p release-assets
          find artifacts/ -name '*.whl' -o -name '*.tar.gz' | xargs -I{} cp {} release-assets/
          echo "Contents of release-assets/ (all go to GitHub Release + PyPI):"
          ls -la release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: release-assets/*

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: release-assets/